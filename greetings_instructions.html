<!DOCTYPE html>
<html>
    <head>
        <title>104_cse_experiment</title>
        <script src="jspsych/dist/jspsych.js"></script>
        <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/dist/plugin-html-button-response.js"></script>
        <script src="jspsych/dist/plugin-survey-likert.js"></script>
        <script src="jspsych/dist/plugin-fullscreen.js"></script>
        <script src="mytrials.js"></script>
        <script src="jspsych/dist/plugin-html-slider-response.js"></script>
        <script src="jspsych/dist/plugin-survey-likert.js"></script>
        <script src="jspsych/dist/plugin-html-button-response.js"></script>
        <script src="vasdislike/vasdislike.js"></script>
        <script src="panas/panas.js"></script>
        <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
        <link href="styles.css" rel="stylesheet" type="text/css" />
        <script src="jspsych/dist/plugin-survey-multi-choice.js"></script>
        <script src="demographic_information.js"></script>
    </head>
    <body></body>
    <script>


        //De
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const debug = urlParams.get('debug');
        if(debug == 1){
            var probe_duration = 10;
            var prime_duration = 1;
            var feedback_duration = 1;
            var blank_duration = 1;
            var probe_stim_duration = 1;
            var money = 20000000;
            
        }else{
            var probe_duration = 1000;
            var feedback_duration = 700;
            var prime_duration = 500;
            var blank_duration = 33;
            var probe_stim_duration = 133;
            //Defining money//
            var money = 2000;
        }


        function sampleItems(array, count = 22) {
            let sampled = [];
            let n = array.length;

            for (let i = 0; i < count; i++) {
                let j = i + Math.floor(Math.random() * (n - i)); // Random index from i to n-1
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
                sampled.push(array[i]); // Store the sampled item
            }
        return sampled;
        }
        function read_my_trials(){
            console.log(prime_probe_trials.trials)
            var my_trials = prime_probe_trials.trials
            console.log(my_trials[0]);
            var my_blockset = sampleItems(my_trials, 20);
            console.log(my_blockset);
            return my_blockset;
        }
        var blockset = read_my_trials();
        console.log(blockset);
        var current_block = blockset[0];
        var blockindex = 0;
        

        var subj_code; //a variable that later stores a random subject code
        function makeid(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        } //this function generates a random string of characters

        var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

        subj_code = makeid(6); //generating a random subject code

        console.log(subj_code); //printing the subject code to the console

        jsPsych.data.addProperties({subj_code: subj_code}); //adding the subject code to the data object

        var timeline = [];
       
        var version = jsPsych.randomization.sampleWithoutReplacement([1,2],1)[0]; //Ezzel tudjuk majd váltogatni szerintem a kondíciókat. Majd 5 lesz összesen, szóval, a 2-es helyére 5 jön. 
        
        
        //defining welcome message//
        var welcome = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <img src="Experimental material/University_logo.png" alt=University Logo" style="width: 300px; display: block; margin: auto;">
            <h2>Üdvözlünk a Metatudomány kutatócsoport vizsgálatában!</h2>
                <p>Egy tudományos kutatásban veszel részt, amelynek vezetője Bognár Miklós, az ELTE Affektív Pszichológia Tanszékének kutatója. 
                A kutatás célja megvizsgálni, hogy miként hatnak a büntetés által kiváltott negatív motivációs állapotok a kognitív kontrollra.</p>
                <h3>Részvétel</h3>
                <p>A kutatásban való részvétel teljesen önkéntes. A vizsgálatot bármikor indoklás nélkül megszakíthatod. Ha bármilyen kérdésed, észrevételed vagy problémád van a kutatással kapcsolatban, írj Bognár Miklósnak a <a href="mailto:bognar.miklos@ppk.elte.hu">bognar.miklos@ppk.elte.hu</a> címre.</p>`,
            choices: ['Tovább']
        };
        timeline.push(welcome);

        //Fullscreen//
        timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        message: "<p>A kísérlet teljes képernyős módra vált.</p>",
        button_label: 'Tovább'
        });
        ////////

        /*data handling and informed consent*/
        var data_handling = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2 style="text-align: center;">Adatkezelési tájékoztató</h2>
            <p style="text-align: justify; max-width: 800px; margin: auto;">Szigorúan bizalmasan kezelünk minden olyan személyes információt, amit a kutatás keretén belül gyűjtünk össze. 
                A kutatás során nyert adatokat kóddal ellátva biztonságos számítógépeken tároljuk. A kutatás során nyert adatokat összegezzük. 
                Az ELTE PPK Affektív Pszichológia Tanszék Metatudomány Kutatócsoportja, mint adatkezelő, fenti személyes adataidat bizalmasan kezeli, más adatkezelőnek, adatfeldolgozónak nem adja át.
                E tényállás részleteit a <a href="http://metasciencelab.elte.hu/hozzajarulas-adatkezeleshez/" target=_blank">"Hozzájárulás adatkezeléshez"</a> c. dokumentum tartalmazza.</p>

            <p>Az adatkezelésről szóló szabályzásról részletesebben pedig itt tájékozódhatsz:
                <a href="https://ppk.elte.hu/file/Hozzajarulas_adatkezeleshez_melleklet_2018.pdf" target="_blank">Hozzájárulás adatkezeléshez melléklet</a></p>
            <p>A kutatás során nyert személyes adataidat arra használjuk fel, hogy regisztrálhassuk a részvételért járó kurzuspontokat és a pénzjutalmat. 
            Az azonosítására alkalmas adatokat (NEPTUN kód) ezután törölni fogjuk. A kezelt adatok a következők:</p>

                <ul>
                    <li>NEPTUN-kód</li>
                    <li>Életkor</li>
                    <li>Nem</li>
                    <li>Iskolai végzettség</li>
                </ul>
            <p>Válaszaid nem lesznek semmilyen módon hozzád köthetők. Az anonimizált adataidat más kutatókkal megosztjuk.</p>
            <p><strong>Kérlek, amennyiben egyetértesz a fenti feltételekkel, és hozzájárulsz a kutatásban való részvételhez, kattints az "Igen" gombra.</strong></p>`,
            choices: ['Igen', 'Nem'],
            response_ends_trial: true,
            on_finish: function(data) {
            if (data.response == 1) {
                jsPsych.abortExperiment('<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px; font-weight: bold">A kísérlet véget ért. Köszönjük, hogy részt vettél a vizsgálatban!</p>');
            }
            }
        };
        timeline.push(data_handling);

        /*informed consent*/
        var informed_consent = {
            type:jsPsychHtmlButtonResponse,
            stimulus: `<h2>Beleegyező nyilatkozat</h2>
                <p>Felelősségem teljes tudatában kijelentem, hogy a mai napon az Eötvös Loránd Tudományegyetem, Bognár Miklós kutatásvezető által végzett vizsgálatban</p>
                 <ul>
                    <li>önként veszek részt.</li>
                    <li>a vizsgálat jellegéről, annak megkezdése előtt kielégítő tájékoztatást kaptam.</li>
                    <li>nem szenvedek semmilyen pszichiátriai betegségben.</li>
                    <li>a vizsgálat idején alkohol vagy drogok hatása alatt nem állok.</li>
                 </ul>

                <p>Tudomásul veszem, hogy az azonosításomra alkalmas személyi adataimat bizalmasan kezelik.
                    Hozzájárulok ahhoz, hogy a vizsgálat során a rólam felvett, személyem azonosítására nem alkalmas adatok más kutatók számára is hozzáférhetők legyenek.
                    Fenntartom a jogot arra, hogy a vizsgálat során annak folytatásától bármikor elállhassak. 
                    Ilyen esetben a rólam addig felvett adatokat törölni kell.</p>

                <p>Tudomásul veszem, hogy csak a teljesen befejezett kitöltésért kapok pontot és pénzjutalmat a <em>Pszichológiai kísérletben és tudományos aktivitásban való részvétel</em> nevű kurzuson.</p>

                <p><strong>A kutatásban való részvételem körülményeiről részletes tájékoztatást kaptam, a feltételekkel egyetértek. 
                    Amennyiben egyetértesz a fenti feltételekkel, kattints az "Igen" gombra.</strong></p>`,
            choices: ['Igen', 'Nem'],
            response_ends_trial: true,
            on_finish: function(data) {
                console.log(blockset[0][0].prime);
            if (data.response == 1) {
                jsPsych.abortExperiment('<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px; font-weight: bold">A kísérlet véget ért. Köszönjük, hogy részt vettél a vizsgálatban!</p>');
            }
            }
                        };
        timeline.push(informed_consent);
        timeline.push(education_timeline)

        /*instructions*/
        var instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<h2>Instrukciók</h2>
                <p>Ebben a kísérletben arra vagyunk kíváncsiak, hogy miként befolyásolja a büntetés a konfliktusfeldolgozást. 
                A kísérlet során iránymegjelöléseket fogsz olvasni (FEL, LE, JOBB, BAL). Először egy prime inger fog megjelenni a képernyőn, amin egy irány (pl.: „FEL”) lesz olvasható egymás alatt háromszor. 
                Ezt követően megjelenik a célinger, ami vagy azonos („FEL”) vagy ellentétes („LE”) lesz az előtte bemutatott iránnyal.
                A feladatod az lesz, hogy minél gyorsabban és pontosabban eltaláld a célinger irányát a hozzárendelt billentyű megnyomásával. Fontos, hogy a lehető leggyorsabban reagálj, de közben figyelj a pontosságra is!</p> 
                <p>Kérlek helyezd a billentyűzetre a kezedet a képen látható módon:</p>
                <p>A bal középső ujjadat az „f”-re, a mutató ujjadat a „g”-re, míg a jobb mutató ujjadat az „n”-re, a középső ujjadat pedig a „j”-re!</p>
                <img src="Experimental material/instruction_pic.png" alt="Hand placemante instructions" style="width: 40%; height: 40%;">
                <p style="text-align: center;"><em>Amennyiben készen állsz a kísérlet megkezdésére, nyomj meg egy tetszőleges billentyűt!</em></p>`,
            choices: "ALL_KEYS"
        };
        timeline.push(instructions);
   

        //Fixation cross//
        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: function() {
                if (debug == 1){
                    return 1;
                }else{
                    return Math.random() * (600 - 400) + 400;
                }
            },
            data: {
                task: 'fixation'
            }
        }

        //Prime//
        var prime_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: jsPsych.timelineVariable('prime'),
            choices: "NO_KEYS",
            trial_duration: prime_duration,
            data:{
                task:"prime"
            }
        }

        //Blank//
        var blank = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: ' ',
            choices: "NO_KEYS",
            trial_duration: blank_duration,
            data:{
                task:"blank"
            }
        }

        //Probe//
        var probe_trial = {
            type: jsPsychHtmlKeyboardResponse,            
            stimulus: jsPsych.timelineVariable('probe'),
            choices: ["f", "j", "g", "n"],
            stimulus_duration: probe_stim_duration,
            trial_duration: probe_duration,
            data: {
                correct_response: jsPsych.timelineVariable('correct_response'),
                task: "probe",
                congruency: jsPsych.timelineVariable('congruency'),
                name: jsPsych.timelineVariable('name')
            },
            on_finish: function(data) {
                console.log(blockindex);
                data.correct = data.response === data.correct_response;
            }
        }

        

        //Feedback P-FB-C//
        var feedback_p_fb_c = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
            var last_trial = jsPsych.data.getLastTrialData().values()[0];
            console.log(last_trial);
            var feedback_text;

            if (last_trial.congruency === "congruent") {
                if (last_trial.correct) {
                    feedback_text = "<div style='font-size: 35px; color: black;'>✔</div>";
                } else {
                    money -= 5;
                    feedback_text = '<div style="font-size: 35px; color: black;">✘<br>5 Ft-ot veszítettél</div>';
                }
                } else {
                    feedback_text = "<div style='font-size: 35px; color: black; font-weight: bold;'>&#11036</div>";
                }
                console.log("Money left:", money);
                return feedback_text;
            },
            on_finish: function() {
                if (money <= 0) {
                    jsPsych.abortExperiment('<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px; font-weight: bold">A kísérlet véget ért. Köszönjük, hogy részt vettél a vizsgálatban!</p>');
                };
            },
            data:{
                feedback_type: "punishment_congruent"
            },
            choices: "NO_KEYS",
            trial_duration: feedback_duration,
        };

// Feedback P-FB-I//
var feedback_p_fb_i = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
    var last_trial = jsPsych.data.getLastTrialData().values()[0];
    console.log(last_trial);
    var feedback_text;

    if (last_trial.congruency === "incongruent") {
        if (last_trial.correct) {
            feedback_text = "<div style='font-size: 35px; color: black;'>✔</div>";
        } else {
            money -= 5;
            feedback_text = "<div style='font-size: 35px; color: black;'>✘<br>5 Ft-ot veszítettél</div>";
        }
        } else {
            feedback_text = "<div style='font-size: 35px; color: black; font-weight: bold;'>&#11036</div>";
        }
        console.log("Money left:", money);
        return feedback_text;
    },
    on_finish: function() {
                if (money <= 0) {
                    jsPsych.abortExperiment('<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px; font-weight: bold">A kísérlet véget ért. Köszönjük, hogy részt vettél a vizsgálatban!</p>');
                };
              },
    data:{
        feedback_type: "punishment_incongruent"
            },          
    choices: "NO_KEYS",
    trial_duration: feedback_duration
};

//Feedback N-FB-C//
var feedback_n_fb_c = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
    var last_trial = jsPsych.data.getLastTrialData().values()[0];
    console.log(last_trial);
    var feedback_text;

    if (last_trial.congruency === "congruent") {
        if (last_trial.correct) {
            feedback_text = "<div style='font-size: 35px; color: black;'>✔</div>";
        } else {
            feedback_text = '<div style="font-size: 35px; color: black;">✘</div>';
        }
        } else {
            feedback_text = "<div style='font-size: 35px; color: black; font-weight: bold;'>&#11036</div>";
        }
        console.log("Money left:", money);
        return feedback_text;
        },
        data:{
            feedback_type: "no_punishment_congruent"
        },
        choices: "NO_KEYS",
        trial_duration: feedback_duration
};


//Feedback N-FB-I//
var feedback_n_fb_i = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
    var last_trial = jsPsych.data.getLastTrialData().values()[0];
    console.log(last_trial);
    var feedback_text;

    if (last_trial.congruency === "incongruent") {
        if (last_trial.correct) {
            feedback_text = "<div style='font-size: 35px; color: black;'>✔</div>";
        } else {
            feedback_text = '<div style="font-size: 35px; color: black;">✘</div>';
        }
        } else {
            feedback_text = "<div style='font-size: 35px; color: black; font-weight: bold;'>&#11036</div>";
        }
        console.log("Money left:", money);
        return feedback_text;
        },
        data:{
            feedback_type: "no_punishment_incongruent"
        },
        choices: "NO_KEYS",
        trial_duration: feedback_duration
    };

//Feedback RP-FB-R//
var feedback_rp_fb_r = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
    var last_trial = jsPsych.data.getLastTrialData().values()[0];
    console.log(last_trial);
    var feedback_text;
        if (Math.random() < 0.4) {
            money -= 5;
            feedback_text = "<div style='font-size: 35px; color: black;'>✘<br>5 Ft-ot veszítettél</div>";
        } else {
            feedback_text = "<div style='font-size: 35px; color: black; font-weight: bold;'>&#11036</div>";
        }

        console.log("Money left:", money);
        return feedback_text;
    },
    on_finish: function() {
                if (money <= 0) {
                    jsPsych.abortExperiment('<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px; font-weight: bold">A kísérlet véget ért. Köszönjük, hogy részt vettél a vizsgálatban!</p>');
                }; 
                },
    data:{
        feedback_type: "random_punishment_random"
    },
        choices: "NO_KEYS",
        trial_duration: feedback_duration
};

        var trial_sequence = {
            timeline: [fixation, prime_trial, blank, probe_trial]
        }
        //P-FB-C Session//
        const trial_sequence_p_fb_c = {
            timeline: [trial_sequence, feedback_p_fb_c],
            timeline_variables: current_block,
            repetitions: 1
        }

        const block_intro_punishment = {
            type:jsPsychHtmlKeyboardResponse,
            stimulus: function(){ 
                current_block = blockset[blockindex];
                console.log(blockset[blockindex]);
                console.log(current_block);
                blockindex++;
                console.log(blockindex);
                return `<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px">
                <h3>Kezdődik az első blokk.</h3>
                <p>Ebben a kondícióban a túl lassú vagy pontatlan válaszadásért <strong>5 Ft-t</strong> vonunk le. 
                Ha készen állsz, tedd a bal középső ujjadat az „f”-re, a mutató ujjadat a „g”-re, a jobb mutató ujjadat az „n”-re, a középső ujjadat pedig a „j”-re. Nyomj le egy gombot a kezdéshez.</p>`
            },
            choices: "ALL_KEYS"
        }

        const block_intermission = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p style="text-align: center; max-width: 800px; margin: auto; font-size: 24px"> Vége a blokknak, most pihenhetsz! Ha készen, állsz tedd az ujjaidat a billentyűkre és nyomj le egy gombot.</p>`,
        choices: "ALL_KEYS",
        }

        const block_p_fb_c = {timeline: [block_intro_punishment, trial_sequence_p_fb_c, block_intermission],
            repetitions: 4
        }
        const feedthrough = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            var current_money = money;
            return `<p style="text-align: center; max-width: 800px; margin: auto; font-size: 24px"> A kísérletnek ezen szakasza befejeződött. Összesen <strong>${current_money} forintod</strong> maradt. Ha készen állsz, nyomj le egy gombot a folytatáshoz.</p>`;
        },
        choices: "ALL_KEYS",
        }
        const session_p_fb_c = {timeline: [block_p_fb_c, feedthrough]
        }

        const session_pfbc_panas = {timeline: [session_p_fb_c, panas_timeline, vas_timeline]
        }

        //P-FB-I Session//
        const trial_sequence_p_fb_i = {
            timeline: [trial_sequence, feedback_p_fb_i],
            timeline_variables: current_block,
            repetitions: 1
        }
        const block_p_fb_i = {timeline: [block_intro_punishment, trial_sequence_p_fb_i, block_intermission],
            repetitions: 4
        }

        const session_p_fb_i = {timeline: [block_p_fb_i, feedthrough]
        }

        const session_pfbi_panas = {timeline: [session_p_fb_i, panas_timeline, vas_timeline]
        }

        //N-FB-C Session//
        const trial_sequence_n_fb_c = {
            timeline: [trial_sequence, feedback_n_fb_c],
            timeline_variables: current_block,
            repetitions: 1
        }

        const block_intro_no_punishment = {
            type:jsPsychHtmlKeyboardResponse,
            stimulus: function(){ 
                current_block = blockset[blockindex];
                console.log(blockset[blockindex]);
                console.log(current_block);
                blockindex++;
                console.log(blockindex);
                return  `<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px">
                <h3>Kezdődik az első blokk.</h3>
                <p>Ebben a kondícióban a hibázás <strong>nem jár pénzlevonással</strong>, ugyanakkor törekedj a minél gyorsabb és pontosabb válaszadásra.
                Ha készen állsz, tedd a bal középső ujjadat az „f”-re, a mutató ujjadat a „g”-re, a jobb mutató ujjadat az „n”-re, a középső ujjadat pedig a „j”-re, majd nyomj le egy gombot.</p>`
            },
            choices: "ALL_KEYS"
        }

        const block_n_fb_c = {timeline: [block_intro_no_punishment, trial_sequence_n_fb_c, block_intermission],
            repetitions: 4
        }

        const session_n_fb_c = {timeline: [block_n_fb_c, feedthrough]
        }

        const session_nfbc_panas = {timeline: [session_n_fb_c, panas_timeline, vas_timeline   ]
        }

        //N-FB-I Session//
        const trial_sequence_n_fb_i = {
            timeline: [trial_sequence, feedback_n_fb_i],
            timeline_variables: current_block,
            repetitions: 1
        }
        const block_n_fb_i = {timeline: [block_intro_no_punishment, trial_sequence_n_fb_i, block_intermission],
            repetitions: 4
        }

        const session_n_fb_i = {timeline: [block_n_fb_i, feedthrough]
        }

        const session_nfbi_panas = {timeline: [session_n_fb_i, panas_timeline, vas_timeline   ]
        }

        //RP-FB-R Session//
        const trial_sequence_rp_fb_r = {
            timeline: [trial_sequence, feedback_rp_fb_r],
            timeline_variables: current_block,
            repetitions: 1
        }

        const block_intro_random = {
            type:jsPsychHtmlKeyboardResponse,
            stimulus: `<p style="text-align: justify; max-width: 800px; margin: auto; font-size: 24px">
                <h3>Kezdődik az első blokk.</h3>
                <p>Ebben a kondícióban pénzlevonás érhet a <strong>teljesítményedtől függetlenül</strong>. Törekedj a minél gyorsabb és pontosabb válaszadásra.
                Ha készen állsz, tedd a bal középső ujjadat az „f”-re, a mutató ujjadat a „g”-re, a jobb mutató ujjadat az „n”-re, a középső ujjadat pedig a „j”-re, majd nyomj le egy gombot.</p>`,
            choices: "ALL_KEYS"
        }

        const block_rp_fb_r = {timeline: [block_intro_random, trial_sequence_rp_fb_r, block_intermission],
            repetitions: 4
        }

        const session_rp_fb_r = {timeline: [block_rp_fb_r, feedthrough]
        }

        const session_r_panas = {timeline: [session_rp_fb_r, panas_timeline, vas_timeline   ]
        }
        
        function shuffle_all_sessions() {
                var experimental_array =  [session_pfbc_panas, session_pfbi_panas, session_nfbc_panas, session_nfbi_panas, session_r_panas];
                var shuffledArray = experimental_array.sort((a, b) => 0.5 - Math.random());
                console.log(shuffledArray);
                return shuffledArray;  
            }
        all_sessions_array = shuffle_all_sessions();
        //Nagy összegző//
        var all_sessions = {
            timeline: all_sessions_array
        }          
       
        var goodbye = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<h2>Kísérlet vége</h2>
                <p>Köszönjük, hogy részt vettél a vizsgálatban!</p>`,
            choices: "ALL_KEYS"
        }
        
        timeline.push(all_sessions)
        timeline.push(goodbye);
        jsPsych.run(timeline);

        
    </script>
</html>